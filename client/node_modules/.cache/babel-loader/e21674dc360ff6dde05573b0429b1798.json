{"ast":null,"code":"\"use strict\";\n\nvar _createForOfIteratorHelper = require(\"/Users/ediichim/Documents/workspace/temp/delegation-dashboard.elrond.com/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _regeneratorRuntime = require(\"/Users/ediichim/Documents/workspace/temp/delegation-dashboard.elrond.com/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _classCallCheck = require(\"/Users/ediichim/Documents/workspace/temp/delegation-dashboard.elrond.com/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/ediichim/Documents/workspace/temp/delegation-dashboard.elrond.com/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.HWProvider = void 0;\n\nvar hw_transport_webusb_1 = __importDefault(require(\"@ledgerhq/hw-transport-webusb\"));\n\nvar hw_transport_webhid_1 = __importDefault(require(\"@ledgerhq/hw-transport-webhid\"));\n\nvar hw_transport_u2f_1 = __importDefault(require(\"@ledgerhq/hw-transport-u2f\")); // @ts-ignore\n\n\nvar hw_app_elrond_1 = __importDefault(require(\"@elrondnetwork/hw-app-elrond\"));\n\nvar platform_1 = __importDefault(require(\"platform\"));\n\nvar address_1 = require(\"../address\");\n\nvar signature_1 = require(\"../signature\");\n\nvar versioning_1 = require(\"../versioning\");\n\nvar constants_1 = require(\"./constants\");\n\nvar networkParams_1 = require(\"../networkParams\");\n\nvar HWProvider = /*#__PURE__*/function () {\n  function HWProvider(httpProvider) {\n    _classCallCheck(this, HWProvider);\n\n    this.addressIndex = 0;\n    this.provider = httpProvider;\n  }\n  /**\n   * Creates transport and initialises ledger app.\n   */\n\n\n  _createClass(HWProvider, [{\n    key: \"init\",\n    value: function init() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var transport;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.prev = 0;\n                _context.next = 3;\n                return this.getTransport();\n\n              case 3:\n                transport = _context.sent;\n                this.hwApp = new hw_app_elrond_1.default(transport);\n                return _context.abrupt(\"return\", true);\n\n              case 8:\n                _context.prev = 8;\n                _context.t0 = _context[\"catch\"](0);\n                return _context.abrupt(\"return\", false);\n\n              case 11:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[0, 8]]);\n      }));\n    }\n  }, {\n    key: \"getTransport\",\n    value: function getTransport() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        var webUSBSupported, webHIDSupported;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return hw_transport_webusb_1.default.isSupported();\n\n              case 2:\n                webUSBSupported = _context2.sent;\n                webUSBSupported = webUSBSupported && platform_1.default.name !== \"Opera\";\n\n                if (!webUSBSupported) {\n                  _context2.next = 8;\n                  break;\n                }\n\n                _context2.next = 7;\n                return hw_transport_webusb_1.default.create();\n\n              case 7:\n                return _context2.abrupt(\"return\", _context2.sent);\n\n              case 8:\n                _context2.next = 10;\n                return hw_transport_webhid_1.default.isSupported();\n\n              case 10:\n                webHIDSupported = _context2.sent;\n\n                if (!webHIDSupported) {\n                  _context2.next = 15;\n                  break;\n                }\n\n                _context2.next = 14;\n                return hw_transport_webhid_1.default.open(\"\");\n\n              case 14:\n                return _context2.abrupt(\"return\", _context2.sent);\n\n              case 15:\n                _context2.next = 17;\n                return hw_transport_u2f_1.default.create();\n\n              case 17:\n                return _context2.abrupt(\"return\", _context2.sent);\n\n              case 18:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n    }\n    /**\n     * Returns true if init() was previously called successfully\n     */\n\n  }, {\n    key: \"isInitialized\",\n    value: function isInitialized() {\n      return !!this.hwApp;\n    }\n    /**\n     * Mocked function, returns isInitialized as an async function\n     */\n\n  }, {\n    key: \"isConnected\",\n    value: function isConnected() {\n      var _this = this;\n\n      return new Promise(function (resolve, _) {\n        return resolve(_this.isInitialized());\n      });\n    }\n    /**\n     * Performs a login request by setting the selected index in Ledger and returning that address\n     */\n\n  }, {\n    key: \"login\",\n    value: function login(options) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n        var _yield$this$hwApp$get, address;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context3.next = 2;\n                  break;\n                }\n\n                throw new Error(\"HWApp not initialised, call init() first\");\n\n              case 2:\n                if (options && options.addressIndex) {\n                  this.addressIndex = options.addressIndex;\n                }\n\n                _context3.next = 5;\n                return this.hwApp.setAddress(0, this.addressIndex);\n\n              case 5:\n                _context3.next = 7;\n                return this.hwApp.getAddress(0, this.addressIndex, true);\n\n              case 7:\n                _yield$this$hwApp$get = _context3.sent;\n                address = _yield$this$hwApp$get.address;\n                return _context3.abrupt(\"return\", address);\n\n              case 10:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n    }\n  }, {\n    key: \"getAccounts\",\n    value: function getAccounts() {\n      var page = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n      var pageSize = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 10;\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n        var addresses, startIndex, index, _yield$this$hwApp$get2, address;\n\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context4.next = 2;\n                  break;\n                }\n\n                throw new Error(\"HWApp not initialised, call init() first\");\n\n              case 2:\n                addresses = [];\n                startIndex = page * pageSize;\n                index = startIndex;\n\n              case 5:\n                if (!(index < startIndex + pageSize)) {\n                  _context4.next = 14;\n                  break;\n                }\n\n                _context4.next = 8;\n                return this.hwApp.getAddress(0, index);\n\n              case 8:\n                _yield$this$hwApp$get2 = _context4.sent;\n                address = _yield$this$hwApp$get2.address;\n                addresses.push(address);\n\n              case 11:\n                index++;\n                _context4.next = 5;\n                break;\n\n              case 14:\n                return _context4.abrupt(\"return\", addresses);\n\n              case 15:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n    }\n    /**\n     * Mocks a logout request by returning true\n     */\n\n  }, {\n    key: \"logout\",\n    value: function logout() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context5.next = 2;\n                  break;\n                }\n\n                throw new Error(\"HWApp not initialised, call init() first\");\n\n              case 2:\n                return _context5.abrupt(\"return\", true);\n\n              case 3:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n    }\n    /**\n     * Fetches current selected ledger address\n     */\n\n  }, {\n    key: \"getAddress\",\n    value: function getAddress() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee6() {\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                return _context6.abrupt(\"return\", this.getCurrentAddress());\n\n              case 1:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n    }\n    /**\n     * Signs and sends a transaction. Returns the transaction hash\n     * @param transaction\n     */\n\n  }, {\n    key: \"sendTransaction\",\n    value: function sendTransaction(transaction) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee7() {\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.next = 2;\n                return this.signTransaction(transaction);\n\n              case 2:\n                transaction = _context7.sent;\n                _context7.next = 5;\n                return transaction.send(this.provider);\n\n              case 5:\n                return _context7.abrupt(\"return\", transaction);\n\n              case 6:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n    }\n  }, {\n    key: \"signTransaction\",\n    value: function signTransaction(transaction) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee8() {\n        var address, signUsingHash, sig;\n        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context8.next = 2;\n                  break;\n                }\n\n                throw new Error(\"HWApp not initialised, call init() first\");\n\n              case 2:\n                _context8.next = 4;\n                return this.getCurrentAddress();\n\n              case 4:\n                address = _context8.sent;\n                _context8.next = 7;\n                return this.shouldSignUsingHash();\n\n              case 7:\n                signUsingHash = _context8.sent;\n\n                if (signUsingHash) {\n                  transaction.options = networkParams_1.TransactionOptions.withTxHashSignOptions();\n                  transaction.version = networkParams_1.TransactionVersion.withTxHashSignVersion();\n                }\n\n                _context8.next = 11;\n                return this.hwApp.signTransaction(transaction.serializeForSigning(new address_1.Address(address)), signUsingHash);\n\n              case 11:\n                sig = _context8.sent;\n                transaction.applySignature(new signature_1.Signature(sig), new address_1.Address(address));\n                return _context8.abrupt(\"return\", transaction);\n\n              case 14:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this);\n      }));\n    }\n  }, {\n    key: \"signTransactions\",\n    value: function signTransactions(transactions) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee9() {\n        var retTx, _iterator, _step, tx;\n\n        return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                retTx = [];\n                _iterator = _createForOfIteratorHelper(transactions);\n                _context9.prev = 2;\n\n                _iterator.s();\n\n              case 4:\n                if ((_step = _iterator.n()).done) {\n                  _context9.next = 13;\n                  break;\n                }\n\n                tx = _step.value;\n                _context9.t0 = retTx;\n                _context9.next = 9;\n                return this.signTransaction(tx);\n\n              case 9:\n                _context9.t1 = _context9.sent;\n\n                _context9.t0.push.call(_context9.t0, _context9.t1);\n\n              case 11:\n                _context9.next = 4;\n                break;\n\n              case 13:\n                _context9.next = 18;\n                break;\n\n              case 15:\n                _context9.prev = 15;\n                _context9.t2 = _context9[\"catch\"](2);\n\n                _iterator.e(_context9.t2);\n\n              case 18:\n                _context9.prev = 18;\n\n                _iterator.f();\n\n                return _context9.finish(18);\n\n              case 21:\n                return _context9.abrupt(\"return\", retTx);\n\n              case 22:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this, [[2, 15, 18, 21]]);\n      }));\n    }\n  }, {\n    key: \"signMessage\",\n    value: function signMessage(message) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee10() {\n        var signature;\n        return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context10.next = 2;\n                  break;\n                }\n\n                throw new Error(\"HWApp not initialised, call init() first\");\n\n              case 2:\n                _context10.next = 4;\n                return this.hwApp.signMessage(message.serializeForSigningRaw());\n\n              case 4:\n                signature = _context10.sent;\n                message.applySignature(new signature_1.Signature(signature));\n                return _context10.abrupt(\"return\", message);\n\n              case 7:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n    }\n  }, {\n    key: \"tokenLogin\",\n    value: function tokenLogin(options) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee11() {\n        var _yield$this$hwApp$get3, signature, address;\n\n        return _regeneratorRuntime.wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context11.next = 2;\n                  break;\n                }\n\n                throw new Error(\"HWApp not initialised, call init() first\");\n\n              case 2:\n                if (options && options.addressIndex) {\n                  this.addressIndex = options.addressIndex;\n                }\n\n                _context11.next = 5;\n                return this.hwApp.setAddress(0, this.addressIndex);\n\n              case 5:\n                _context11.next = 7;\n                return this.hwApp.getAddressAndSignAuthToken(0, this.addressIndex, options.token);\n\n              case 7:\n                _yield$this$hwApp$get3 = _context11.sent;\n                signature = _yield$this$hwApp$get3.signature;\n                address = _yield$this$hwApp$get3.address;\n                return _context11.abrupt(\"return\", {\n                  signature: new signature_1.Signature(signature),\n                  address: address\n                });\n\n              case 11:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n    }\n  }, {\n    key: \"shouldSignUsingHash\",\n    value: function shouldSignUsingHash() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee12() {\n        var config, diff;\n        return _regeneratorRuntime.wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context12.next = 2;\n                  break;\n                }\n\n                throw new Error(\"HWApp not initialised, call init() first\");\n\n              case 2:\n                _context12.next = 4;\n                return this.hwApp.getAppConfiguration();\n\n              case 4:\n                config = _context12.sent;\n                diff = versioning_1.compareVersions(config.version, constants_1.LEDGER_TX_HASH_SIGN_MIN_VERSION);\n                return _context12.abrupt(\"return\", diff >= 0);\n\n              case 7:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n    }\n  }, {\n    key: \"getCurrentAddress\",\n    value: function getCurrentAddress() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee13() {\n        var _yield$this$hwApp$get4, address;\n\n        return _regeneratorRuntime.wrap(function _callee13$(_context13) {\n          while (1) {\n            switch (_context13.prev = _context13.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context13.next = 2;\n                  break;\n                }\n\n                throw new Error(\"HWApp not initialised, call init() first\");\n\n              case 2:\n                _context13.next = 4;\n                return this.hwApp.getAddress(0, this.addressIndex);\n\n              case 4:\n                _yield$this$hwApp$get4 = _context13.sent;\n                address = _yield$this$hwApp$get4.address;\n                return _context13.abrupt(\"return\", address);\n\n              case 7:\n              case \"end\":\n                return _context13.stop();\n            }\n          }\n        }, _callee13, this);\n      }));\n    }\n  }]);\n\n  return HWProvider;\n}();\n\nexports.HWProvider = HWProvider;","map":{"version":3,"sources":["../../src/dapp/hwProvider.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAA,qBAAA,GAAA,eAAA,CAAA,OAAA,CAAA,+BAAA,CAAA,CAAA;;AACA,IAAA,qBAAA,GAAA,eAAA,CAAA,OAAA,CAAA,+BAAA,CAAA,CAAA;;AACA,IAAA,kBAAA,GAAA,eAAA,CAAA,OAAA,CAAA,4BAAA,CAAA,CAAA,C,CACA;;;AACA,IAAA,eAAA,GAAA,eAAA,CAAA,OAAA,CAAA,8BAAA,CAAA,CAAA;;AAEA,IAAA,UAAA,GAAA,eAAA,CAAA,OAAA,CAAA,UAAA,CAAA,CAAA;;AAMA,IAAA,SAAA,GAAA,OAAA,CAAA,YAAA,CAAA;;AACA,IAAA,WAAA,GAAA,OAAA,CAAA,cAAA,CAAA;;AACA,IAAA,YAAA,GAAA,OAAA,CAAA,eAAA,CAAA;;AACA,IAAA,WAAA,GAAA,OAAA,CAAA,aAAA,CAAA;;AACA,IAAA,eAAA,GAAA,OAAA,CAAA,kBAAA,CAAA;;IAGa,U;AAKT,sBAAY,YAAZ,EAAmC;AAAA;;AAFnC,SAAA,YAAA,GAAuB,CAAvB;AAGI,SAAK,QAAL,GAAgB,YAAhB;AACH;AAED;;AAEG;;;;;WACG,gBAAI;;;;;;;;;AAEgB,uBAAM,KAAK,YAAL,EAAN;;;AAAZ,gBAAA,S;AACN,qBAAK,KAAL,GAAa,IAAI,eAAA,CAAA,OAAJ,CAAc,SAAd,CAAb;iDAEO,I;;;;;iDAEA,K;;;;;;;;;AAEd;;;WAEK,wBAAY;;;;;;;;AACQ,uBAAM,qBAAA,CAAA,OAAA,CAAgB,WAAhB,EAAN;;;AAAlB,gBAAA,e;AACJ,gBAAA,eAAe,GACb,eAAe,IACb,UAAA,CAAA,OAAA,CAAS,IAAT,KAAkB,OAFtB;;qBAII,e;;;;;;AACO,uBAAM,qBAAA,CAAA,OAAA,CAAgB,MAAhB,EAAN;;;;;;;AAGW,uBAAM,qBAAA,CAAA,OAAA,CAAgB,WAAhB,EAAN;;;AAAlB,gBAAA,e;;qBACA,e;;;;;;AACO,uBAAM,qBAAA,CAAA,OAAA,CAAgB,IAAhB,CAAqB,EAArB,CAAN;;;;;;;AAGJ,uBAAM,kBAAA,CAAA,OAAA,CAAa,MAAb,EAAN;;;;;;;;;;;;AACV;AAED;;AAEG;;;;WACH,yBAAa;AACT,aAAO,CAAC,CAAC,KAAK,KAAd;AACH;AAED;;AAEG;;;;WACH,uBAAW;AAAA;;AACP,aAAO,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,CAAV;AAAA,eAAgB,OAAO,CAAC,KAAI,CAAC,aAAL,EAAD,CAAvB;AAAA,OAAZ,CAAP;AACH;AAED;;AAEG;;;;WACG,eAAM,OAAN,EAAyC;;;;;;;;oBACtC,KAAK,K;;;;;sBACA,IAAI,KAAJ,CAAU,0CAAV,C;;;AAGV,oBAAG,OAAO,IAAI,OAAO,CAAC,YAAtB,EAAoC;AAChC,uBAAK,YAAL,GAAoB,OAAO,CAAC,YAA5B;AACH;;;AAED,uBAAM,KAAK,KAAL,CAAW,UAAX,CAAsB,CAAtB,EAAyB,KAAK,YAA9B,CAAN;;;;AACkB,uBAAM,KAAK,KAAL,CAAW,UAAX,CAAsB,CAAtB,EAAyB,KAAK,YAA9B,EAA4C,IAA5C,CAAN;;;;AAAX,gBAAA,O,yBAAA,O;kDAEA,O;;;;;;;;;AACV;;;WAEK,uBAAmD;AAAA,UAAvC,IAAuC,uEAAxB,CAAwB;AAAA,UAArB,QAAqB,uEAAF,EAAE;;;;;;;;oBAChD,KAAK,K;;;;;sBACA,IAAI,KAAJ,CAAU,0CAAV,C;;;AAEJ,gBAAA,S,GAAY,E;AAEZ,gBAAA,U,GAAa,IAAI,GAAG,Q;AACjB,gBAAA,K,GAAQ,U;;;sBAAY,KAAK,GAAG,UAAU,GAAG,Q;;;;;;AAC1B,uBAAM,KAAK,KAAL,CAAW,UAAX,CAAsB,CAAtB,EAAyB,KAAzB,CAAN;;;;AAAZ,gBAAA,O,0BAAA,O;AACR,gBAAA,SAAS,CAAC,IAAV,CAAe,OAAf;;;AAFwD,gBAAA,KAAK,E;;;;;kDAI1D,S;;;;;;;;;AACV;AAED;;AAEG;;;;WACG,kBAAM;;;;;;oBACH,KAAK,K;;;;;sBACA,IAAI,KAAJ,CAAU,0CAAV,C;;;kDAGH,I;;;;;;;;;AACV;AAED;;AAEG;;;;WACG,sBAAU;;;;;;kDACL,KAAK,iBAAL,E;;;;;;;;;AACV;AAED;;;AAGG;;;;WACG,yBAAgB,WAAhB,EAAwC;;;;;;;AAC5B,uBAAM,KAAK,eAAL,CAAqB,WAArB,CAAN;;;AAAd,gBAAA,W;;AACA,uBAAM,WAAW,CAAC,IAAZ,CAAiB,KAAK,QAAtB,CAAN;;;kDAEO,W;;;;;;;;;AACV;;;WAEK,yBAAgB,WAAhB,EAAwC;;;;;;;oBACrC,KAAK,K;;;;;sBACA,IAAI,KAAJ,CAAU,0CAAV,C;;;;AAGM,uBAAM,KAAK,iBAAL,EAAN;;;AAAV,gBAAA,O;;AACc,uBAAM,KAAK,mBAAL,EAAN;;;AAAhB,gBAAA,a;;AACJ,oBAAG,aAAH,EAAkB;AACd,kBAAA,WAAW,CAAC,OAAZ,GAAsB,eAAA,CAAA,kBAAA,CAAmB,qBAAnB,EAAtB;AACA,kBAAA,WAAW,CAAC,OAAZ,GAAsB,eAAA,CAAA,kBAAA,CAAmB,qBAAnB,EAAtB;AACH;;;AACW,uBAAM,KAAK,KAAL,CAAW,eAAX,CAChB,WAAW,CAAC,mBAAZ,CAAgC,IAAI,SAAA,CAAA,OAAJ,CAAY,OAAZ,CAAhC,CADgB,EAEhB,aAFgB,CAAN;;;AAAN,gBAAA,G;AAIN,gBAAA,WAAW,CAAC,cAAZ,CAA2B,IAAI,WAAA,CAAA,SAAJ,CAAc,GAAd,CAA3B,EAA+C,IAAI,SAAA,CAAA,OAAJ,CAAY,OAAZ,CAA/C;kDAEO,W;;;;;;;;;AACV;;;WAEK,0BAAiB,YAAjB,EAA4C;;;;;;;;AAC1C,gBAAA,K,GAAuB,E;uDACZ,Y;;;;;;;;;;;AAAN,gBAAA,E;+BACL,K;;AAAW,uBAAM,KAAK,eAAL,CAAqB,EAArB,CAAN;;;;;6BAAL,I;;;;;;;;;;;;;;;;;;;;;;;;kDAGH,K;;;;;;;;;AACV;;;WAEK,qBAAY,OAAZ,EAAoC;;;;;;;oBACjC,KAAK,K;;;;;sBACA,IAAI,KAAJ,CAAU,0CAAV,C;;;;AAGQ,uBAAM,KAAK,KAAL,CAAW,WAAX,CAAuB,OAAO,CAAC,sBAAR,EAAvB,CAAN;;;AAAZ,gBAAA,S;AACN,gBAAA,OAAO,CAAC,cAAR,CAAuB,IAAI,WAAA,CAAA,SAAJ,CAAc,SAAd,CAAvB;mDAEO,O;;;;;;;;;AACV;;;WAEK,oBAAW,OAAX,EAA4D;;;;;;;;oBACzD,KAAK,K;;;;;sBACA,IAAI,KAAJ,CAAU,0CAAV,C;;;AAGV,oBAAG,OAAO,IAAI,OAAO,CAAC,YAAtB,EAAoC;AAChC,uBAAK,YAAL,GAAoB,OAAO,CAAC,YAA5B;AACH;;;AAED,uBAAM,KAAK,KAAL,CAAW,UAAX,CAAsB,CAAtB,EAAyB,KAAK,YAA9B,CAAN;;;;AAE+B,uBAAM,KAAK,KAAL,CAAW,0BAAX,CAAsC,CAAtC,EAAyC,KAAK,YAA9C,EAA4D,OAAO,CAAC,KAApE,CAAN;;;;AAAvB,gBAAA,S,0BAAA,S;AAAW,gBAAA,O,0BAAA,O;mDAEZ;AACH,kBAAA,SAAS,EAAE,IAAI,WAAA,CAAA,SAAJ,CAAc,SAAd,CADR;AAEH,kBAAA,OAAO,EAAP;AAFG,iB;;;;;;;;;AAIV;;;WAEa,+BAAmB;;;;;;;oBACxB,KAAK,K;;;;;sBACA,IAAI,KAAJ,CAAU,0CAAV,C;;;;AAGK,uBAAM,KAAK,KAAL,CAAW,mBAAX,EAAN;;;AAAT,gBAAA,M;AAEF,gBAAA,I,GAAO,YAAA,CAAA,eAAA,CAAgB,MAAM,CAAC,OAAvB,EAAgC,WAAA,CAAA,+BAAhC,C;mDACJ,IAAI,IAAI,C;;;;;;;;;AAClB;;;WAEa,6BAAiB;;;;;;;;oBACtB,KAAK,K;;;;;sBACA,IAAI,KAAJ,CAAU,0CAAV,C;;;;AAEU,uBAAM,KAAK,KAAL,CAAW,UAAX,CAAsB,CAAtB,EAAyB,KAAK,YAA9B,CAAN;;;;AAAZ,gBAAA,O,0BAAA,O;mDAED,O;;;;;;;;;AACV;;;;;;AAjML,OAAA,CAAA,UAAA,GAAA,UAAA","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.HWProvider = void 0;\nconst hw_transport_webusb_1 = __importDefault(require(\"@ledgerhq/hw-transport-webusb\"));\nconst hw_transport_webhid_1 = __importDefault(require(\"@ledgerhq/hw-transport-webhid\"));\nconst hw_transport_u2f_1 = __importDefault(require(\"@ledgerhq/hw-transport-u2f\"));\n// @ts-ignore\nconst hw_app_elrond_1 = __importDefault(require(\"@elrondnetwork/hw-app-elrond\"));\nconst platform_1 = __importDefault(require(\"platform\"));\nconst address_1 = require(\"../address\");\nconst signature_1 = require(\"../signature\");\nconst versioning_1 = require(\"../versioning\");\nconst constants_1 = require(\"./constants\");\nconst networkParams_1 = require(\"../networkParams\");\nclass HWProvider {\n    constructor(httpProvider) {\n        this.addressIndex = 0;\n        this.provider = httpProvider;\n    }\n    /**\n     * Creates transport and initialises ledger app.\n     */\n    init() {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                const transport = yield this.getTransport();\n                this.hwApp = new hw_app_elrond_1.default(transport);\n                return true;\n            }\n            catch (error) {\n                return false;\n            }\n        });\n    }\n    getTransport() {\n        return __awaiter(this, void 0, void 0, function* () {\n            let webUSBSupported = yield hw_transport_webusb_1.default.isSupported();\n            webUSBSupported =\n                webUSBSupported &&\n                    platform_1.default.name !== \"Opera\";\n            if (webUSBSupported) {\n                return yield hw_transport_webusb_1.default.create();\n            }\n            let webHIDSupported = yield hw_transport_webhid_1.default.isSupported();\n            if (webHIDSupported) {\n                return yield hw_transport_webhid_1.default.open(\"\");\n            }\n            return yield hw_transport_u2f_1.default.create();\n        });\n    }\n    /**\n     * Returns true if init() was previously called successfully\n     */\n    isInitialized() {\n        return !!this.hwApp;\n    }\n    /**\n     * Mocked function, returns isInitialized as an async function\n     */\n    isConnected() {\n        return new Promise((resolve, _) => resolve(this.isInitialized()));\n    }\n    /**\n     * Performs a login request by setting the selected index in Ledger and returning that address\n     */\n    login(options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            if (options && options.addressIndex) {\n                this.addressIndex = options.addressIndex;\n            }\n            yield this.hwApp.setAddress(0, this.addressIndex);\n            const { address } = yield this.hwApp.getAddress(0, this.addressIndex, true);\n            return address;\n        });\n    }\n    getAccounts(page = 0, pageSize = 10) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const addresses = [];\n            const startIndex = page * pageSize;\n            for (let index = startIndex; index < startIndex + pageSize; index++) {\n                const { address } = yield this.hwApp.getAddress(0, index);\n                addresses.push(address);\n            }\n            return addresses;\n        });\n    }\n    /**\n     * Mocks a logout request by returning true\n     */\n    logout() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            return true;\n        });\n    }\n    /**\n     * Fetches current selected ledger address\n     */\n    getAddress() {\n        return __awaiter(this, void 0, void 0, function* () {\n            return this.getCurrentAddress();\n        });\n    }\n    /**\n     * Signs and sends a transaction. Returns the transaction hash\n     * @param transaction\n     */\n    sendTransaction(transaction) {\n        return __awaiter(this, void 0, void 0, function* () {\n            transaction = yield this.signTransaction(transaction);\n            yield transaction.send(this.provider);\n            return transaction;\n        });\n    }\n    signTransaction(transaction) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const address = yield this.getCurrentAddress();\n            let signUsingHash = yield this.shouldSignUsingHash();\n            if (signUsingHash) {\n                transaction.options = networkParams_1.TransactionOptions.withTxHashSignOptions();\n                transaction.version = networkParams_1.TransactionVersion.withTxHashSignVersion();\n            }\n            const sig = yield this.hwApp.signTransaction(transaction.serializeForSigning(new address_1.Address(address)), signUsingHash);\n            transaction.applySignature(new signature_1.Signature(sig), new address_1.Address(address));\n            return transaction;\n        });\n    }\n    signTransactions(transactions) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let retTx = [];\n            for (let tx of transactions) {\n                retTx.push(yield this.signTransaction(tx));\n            }\n            return retTx;\n        });\n    }\n    signMessage(message) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const signature = yield this.hwApp.signMessage(message.serializeForSigningRaw());\n            message.applySignature(new signature_1.Signature(signature));\n            return message;\n        });\n    }\n    tokenLogin(options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            if (options && options.addressIndex) {\n                this.addressIndex = options.addressIndex;\n            }\n            yield this.hwApp.setAddress(0, this.addressIndex);\n            const { signature, address } = yield this.hwApp.getAddressAndSignAuthToken(0, this.addressIndex, options.token);\n            return {\n                signature: new signature_1.Signature(signature),\n                address\n            };\n        });\n    }\n    shouldSignUsingHash() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const config = yield this.hwApp.getAppConfiguration();\n            let diff = versioning_1.compareVersions(config.version, constants_1.LEDGER_TX_HASH_SIGN_MIN_VERSION);\n            return diff >= 0;\n        });\n    }\n    getCurrentAddress() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const { address } = yield this.hwApp.getAddress(0, this.addressIndex);\n            return address;\n        });\n    }\n}\nexports.HWProvider = HWProvider;\n//# sourceMappingURL=hwProvider.js.map"]},"metadata":{},"sourceType":"script"}